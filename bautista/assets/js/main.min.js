function loadData(){$.ajax({url:"./config.json",dataType:"json",success:function(a){for(console.log("Datos cargados!"),data=a,i=0;i<data.students.length;i++)$("#students").append('<option value="'+parseInt(i+1)+'">'+data.students[i].desc+"</option>"),cont.push(0)},error:function(a,b,c){console.log(a.status),console.log(c)}})}function calculateInterest(a,b){var c=Date.now(),d=new Date(a),e=Math.abs(c-d),f=Math.floor(e/1e3/86400);c>d?interest=Math.round(b*(data.interest*f)):interest=0;var g=interest%10;return g>0&&(g>=5?interest+=10-g:interest-=g),interest}function calculateProjectedInterest(a,b,c){var d=new Date(a),e=new Date(b),f=Math.abs(d-e),g=Math.floor(f/1e3/86400);d>e?interest=Math.round(c*(data.interest*g)):interest=0;var h=interest%10;return h>0&&(h>=5?interest+=10-h:interest-=h),interest}function addProjectedChecks(){var a=$("#fecha").val(),b=$("#p").val();if($("#div-p").removeClass("has-error"),$("#help-p").html(""),$("#div-fecha").removeClass("has-error"),$("#help-fecha").html(""),""==b||isNaN(b)||parseInt(b)<=0)$("#div-p").addClass("has-error"),$("#p").focus(),$("#help-p").html("Ingrese una cantidad valida...");else if(""==a)$("#div-fecha").addClass("has-error"),$("#fecha").focus(),$("#help-fecha").html("Ingrese una fecha valida...");else{var c=[a,parseInt(b),Math.floor(Date.now()/1e3)];projectedChecks.push(c),$("#modalDocument").modal("hide"),$("#p").val(""),projectedChecks.sort(function(a,b){return new Date(a[0])-new Date(b[0])}),showProjectedChecks()}}function showProjectedChecks(){projectedChecks.length>0?($("#checks-div").removeClass("hide"),generateRowsChecks()):($("#checks-div").addClass("hide"),calculateProjectedChecks())}function deleteCheck(a){projectedChecks.splice(a,1),showProjectedChecks()}function calculateProjectedChecks(){for(checksData=[],i=0;i<data.dues;i++)for(j=0;j<studentsData.length;j++)studentsData[j][3][i][1]>0&&checksData.push([studentsData[j][3][i][0],studentsData[j][3][i][1],studentsData[j][3][i][2],0,0]);var a=0;for(i=0;i<projectedChecks.length;i++)for(a=projectedChecks[i][1],j=0;j<checksData.length;j++)if(0==checksData[j][4]){var b=calculateProjectedInterest(projectedChecks[i][0],checksData[j][0],checksData[j][1]),c=checksData[j][1]+b-checksData[j][2]-checksData[j][3];if(c>a){checksData[j][3]=a,a=0;break}checksData[j][4]=1,checksData[j][3]=0,a-=c}generateRows(),a>0&&$("#table").append('<tr class="warning"><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td colspan="4"><strong>Existe un sobre pago en los cheques de:</strong> $'+a.format(0,3,".")+"</td></tr>")}function generateRowsChecks(){for($("#tableProyectedChecks").html(""),i=0;i<projectedChecks.length;i++){var a='<tr id="row-proyected-checks-'+i+'">';a+="<td>"+projectedChecks[i][0]+"</td>",a+="<td>$"+projectedChecks[i][1].format(0,3,".")+"</td>",a+='<td><button onclick="deleteCheck('+i+')" type="button" class="btn btn-xs btn-danger"name="button">Eliminar</button></td>  </tr>',$("#tableProyectedChecks").append(a)}calculateProjectedChecks()}function addStudent(){var a=parseInt($("#students").val()),b=$("#tag-student").val();if(null!=a&&""!=a&&a>0){cont[a-1]+=1;var c=[];for(""==b&&(b=data.students[a-1].desc+" #"+cont[a-1]),j=0;j<data.dues;j++){var d=new Date(data.start_date);d.setMonth(d.getMonth()+j);var e=d.getDate()+1,f=d.getMonth()+1,g=d.getFullYear();e<10&&(e="0"+e),f<10&&(f="0"+f);var d=g+"-"+f+"-"+e;c[j]=[d,data.students[a-1].monthly_payment,0]}studentsData[numID]=[b,data.students[a-1].monthly_payment,[],c],$("#student-created").prepend('<option value="'+numID+'">'+b+"</option>"),numID+=1,calculateProjectedChecks(),$("#tag-student").val("")}}function addDiscount(){var a=$("#student-created").val(),b=$("#discount").val();$("#div-discount").removeClass("has-error"),$("#student-created").removeClass("has-error"),$("#help-student-created").html(""),9999==a||null==a?($("#div-student-created").addClass("has-error"),$("#student-created").focus(),$("#help-student-created").html("Debe seleccionar un alumno...")):""==b||isNaN(b)||parseInt(b)>100||parseInt(b)<=0?($("#div-discount").addClass("has-error"),$("#discount").focus()):(studentsData[a][2].push(b),$("#discount").val("")),calculateProjectedChecks()}function generateRows(){$("#table").html(""),amount=0,grossAmount=0,interestAmount=0;var a=0;for(i=0;i<data.dues;i++)for(j=0;j<studentsData.length;j++)if(studentsData[j][3][i][1]>0){for(studentsData[j][3][i][1]=studentsData[j][1],k=0;k<studentsData[j][2].length;k++)studentsData[j][3][i][1]=studentsData[j][3][i][1]-studentsData[j][3][i][1]*(.01*studentsData[j][2][k]);var b=calculateInterest(studentsData[j][3][i][0],studentsData[j][3][i][1]),c=studentsData[j][3][i][1]+b;if(c<=studentsData[j][3][i][2]&&(studentsData[j][3][i][2]=0),c-=studentsData[j][3][i][2],checksData.length>0)if(1==checksData[a][4]){var d='<tr id="row-'+j+"-"+i+'" class="success">';d+="<td>"+studentsData[j][0]+"</td>",d+="<td>["+studentsData[j][2].toString()+"]%</td>",d+="<td>"+(i+1)+"/"+data.dues+"</td>",d+="<td>"+studentsData[j][3][i][0]+"</td>",d+='<td id="gross-'+j+"-"+i+'">$'+studentsData[j][3][i][1].format(0,3,".")+"</td>",d+='<td id="interest-'+j+"-"+i+'">$'+b.format(0,3,".")+"</td>",d+='<td><input type="text" value="'+studentsData[j][3][i][2].format(0,3,".")+'" id="deposit-'+j+"-"+i+'"> <button class="btn btn-xs btn-info" onclick="addDeposit('+j+","+i+')">Aplicar</button></td>',d+='<td id="amount-total-'+j+"-"+i+'">$'+c.format(0,3,".")+"</td>",d+="<td>Pagado</td>",d+='<td><input type="checkbox" value="'+j+"-"+i+'"></td>',d+='<td><button onclick="deleteDue('+j+","+i+')" type="button" class="btn btn-xs btn-danger"name="button">Eliminar</button></td>  </tr>'}else if(0==checksData[a][4]&&checksData[a][3]>0){var d='<tr id="row-'+j+"-"+i+'" class="info">';d+="<td>"+studentsData[j][0]+"</td>",d+="<td>["+studentsData[j][2].toString()+"]%</td>",d+="<td>"+(i+1)+"/"+data.dues+"</td>",d+="<td>"+studentsData[j][3][i][0]+"</td>",d+='<td id="gross-'+j+"-"+i+'">$'+studentsData[j][3][i][1].format(0,3,".")+"</td>",d+='<td id="interest-'+j+"-"+i+'">$'+b.format(0,3,".")+"</td>",d+='<td><input type="text" value="'+studentsData[j][3][i][2].format(0,3,".")+'" id="deposit-'+j+"-"+i+'"> <button class="btn btn-xs btn-info" onclick="addDeposit('+j+","+i+')">Aplicar</button></td>',d+='<td id="amount-total-'+j+"-"+i+'">$'+c.format(0,3,".")+"</td>",d+="<td>Abono de $"+checksData[a][3].format(0,3,".")+"</td>",d+='<td><input type="checkbox" value="'+j+"-"+i+'"></td>',d+='<td><button onclick="deleteDue('+j+","+i+')" type="button" class="btn btn-xs btn-danger"name="button">Eliminar</button></td>  </tr>'}else{var d='<tr id="row-'+j+"-"+i+'">';d+="<td>"+studentsData[j][0]+"</td>",d+="<td>["+studentsData[j][2].toString()+"]%</td>",d+="<td>"+(i+1)+"/"+data.dues+"</td>",d+="<td>"+studentsData[j][3][i][0]+"</td>",d+='<td id="gross-'+j+"-"+i+'">$'+studentsData[j][3][i][1].format(0,3,".")+"</td>",d+='<td id="interest-'+j+"-"+i+'">$'+b.format(0,3,".")+"</td>",d+='<td><input type="text" value="'+studentsData[j][3][i][2].format(0,3,".")+'" id="deposit-'+j+"-"+i+'"> <button class="btn btn-xs btn-info" onclick="addDeposit('+j+","+i+')">Aplicar</button></td>',d+='<td id="amount-total-'+j+"-"+i+'">$'+c.format(0,3,".")+"</td>",d+="<td>En Deuda</td>",d+='<td><input type="checkbox" value="'+j+"-"+i+'"></td>',d+='<td><button onclick="deleteDue('+j+","+i+')" type="button" class="btn btn-xs btn-danger"name="button">Eliminar</button></td>  </tr>'}else{var d='<tr id="row-'+j+"-"+i+'">';d+="<td>"+studentsData[j][0]+"</td>",d+="<td>["+studentsData[j][2].toString()+"]%</td>",d+="<td>"+(i+1)+"/"+data.dues+"</td>",d+="<td>"+studentsData[j][3][i][0]+"</td>",d+='<td id="gross-'+j+"-"+i+'">$'+studentsData[j][3][i][1].format(0,3,".")+"</td>",d+='<td id="interest-'+j+"-"+i+'">$'+b.format(0,3,".")+"</td>",d+='<td><input type="text" value="'+studentsData[j][3][i][2].format(0,3,".")+'" id="deposit-'+j+"-"+i+'"> <button class="btn btn-xs btn-info" onclick="addDeposit('+j+","+i+')">Aplicar</button></td>',d+='<td id="amount-total-'+j+"-"+i+'">$'+c.format(0,3,".")+"</td>",d+="<td>En Deuda</td>",d+="<td></td>",d+='<td><button onclick="deleteDue('+j+","+i+')" type="button" class="btn btn-xs btn-danger"name="button">Eliminar</button></td>  </tr>'}$("#table").append(d),a+=1,amount+=c,grossAmount+=studentsData[j][3][i][1],interestAmount+=b}else{var d='<tr id="row-'+j+"-"+i+'" class="danger">';d+="<td>"+studentsData[j][0]+"</td>",d+="<td>["+studentsData[j][2].toString()+"]%</td>",d+="<td>"+(i+1)+"/"+data.dues+"</td>",d+="<td>"+studentsData[j][3][i][0]+"</td>",d+="<td>$0</td>",d+="<td>$0</td>",d+="<td></td>",d+="<td>$0</td>",d+="<td>Cancelado</td>",d+="<td></td>",d+='<td><button onclick="restoreDue('+j+","+i+')" type="button" class="btn btn-xs btn-success"name="button">Resturar</button></td>  </tr>',$("#table").append(d)}$("#table").append('<tr id="row-total"><td></td><td></td><td></td><td></td><td><strong>Deuda Capital:</strong> $'+grossAmount.format(0,3,".")+"</td><td><strong>Intereses:</strong> $"+interestAmount.format(0,3,".")+"</td><td></td><td><strong>Total:</strong> $"+amount.format(0,3,".")+"</td><td></td><td></td><td></td></tr>")}function addDeposit(a,b){var c=$("#deposit-"+a+"-"+b).val().replace(".","");""==c||isNaN(c)||parseInt(discount)<0?$("#deposit-"+a+"-"+b).focus():(studentsData[a][3][b][2]=parseInt(c),calculateProjectedChecks())}function deleteDue(a,b){studentsData[a][3][b][1]=0,calculateProjectedChecks()}function restoreDue(a,b){studentsData[a][3][b][1]=studentsData[a][1],calculateProjectedChecks()}function calculateChecks(){if(calculatedChecks=[],calculatedChecksData=[],$("#table :checked").each(function(){calculatedChecks.push($(this).val())}),calculatedChecks.length>0){for(k=0;k<calculatedChecks.length;k++){var a=calculatedChecks[k].split("-"),b=parseInt(a[1]),c=parseInt(a[0]);calculatedChecksData.push([studentsData[c][0],b+1+"/"+data.dues,studentsData[c][3][b]])}$("#page-1").addClass("hide"),$("#page-2").removeClass("hide"),generateRowsChecksSeleted()}else console.log("nada")}function generateRowsChecksSeleted(){$("#table-3-checks").addClass("hide"),$("#n_checks").val("");var a=0;for($("#table-2").html(""),k=0;k<calculatedChecksData.length;k++){var b=calculateInterest(calculatedChecksData[k][2][0],calculatedChecksData[k][2][1]),c=calculatedChecksData[k][2][1]+b-calculatedChecksData[k][2][2],d="<tr>";d+="<td>"+calculatedChecksData[k][0]+"</td>",d+="<td>"+calculatedChecksData[k][1]+"</td>",d+="<td>"+calculatedChecksData[k][2][0]+"</td>",d+="<td>$"+calculatedChecksData[k][2][1].format(0,3,".")+"</td>",d+="<td>$"+c.format(0,3,".")+"</td>",d+="</tr>",a+=c,$("#table-2").append(d)}$("#table-2").append("<tr><td></td><td></td><td></td><td></td><td><strong>Total:</strong> $"+a.format(0,3,".")+"</td></tr>")}function generateNumberOfChecks(){totalChecksGenerate=0;var a=$("#n_checks").val();if(""==a||isNaN(a)||parseInt(a)<0)$("#n_checks").focus();else{$("#table-3-checks").removeClass("hide"),totalChecksGenerate=a;var b=new Date,c=b.getDate(),d=b.getMonth()+1,e=b.getFullYear();c<10&&(c="0"+c),d<10&&(d="0"+d);var b=e+"-"+d+"-"+c;for($("#table-3").html(""),k=0;k<a;k++){var f="<tr>";f+="<td> Cheque Nº "+(k+1)+"</td>",f+='<td><input type="text" class="form-control" id="fecha-cheque-'+k+'" data-date-format="yyyy-mm-dd"></td>',f+='<td id="total-cheque-'+k+'">$0</td>',f+="</tr>",$("#table-3").append(f),$("#fecha-cheque-"+k).datepicker({format:"yyyy-mm-dd",language:"es",autoclose:!0,startDate:"-1d"}),$("#fecha-cheque-"+k).val(b)}}}function calculateAmountChecks(){var a=0,b=0,c=calculatedChecksData.clone();for(k=0;k<c.length;k++)a+=c[k][2][1];for(b=Math.ceil(a/totalChecksGenerate),amountCheck=[],i=0;i<totalChecksGenerate;i++)for(auxAmountCheck=0,k=0;k<c.length;k++)if(console.log(c[k][2][1]),c[k][2][1]>0){var d=c[k][2][1]+auxAmountCheck;if(!(d<=b)){var e=b-auxAmountCheck;amountCheck.push([i,c[k][2][0],e]),c[k][2][1]-=e;break}auxAmountCheck+=c[k][2][1],amountCheck.push([i,c[k][2][0],c[k][2][1]]),c[k][2][1]=0}var f=0,g=0;for(i=0;i<totalChecksGenerate;i++){var h=$("#fecha-cheque-"+i).val(),j=0;for(k=0;k<amountCheck.length;k++)amountCheck[k][0]==i&&(j+=calculateProjectedInterest(h,amountCheck[k][1],amountCheck[k][2]),j+=amountCheck[k][2]);f+=j}for(k=0;k<c.length;k++)g+=c[k][2][2];f-=g;var l=f%totalChecksGenerate;for(i=0;i<totalChecksGenerate;i++){var m=parseInt(f/totalChecksGenerate);0==i&&(m+=l);var n=m%10;n>0&&(n>=5?m+=10-n:m-=n),$("#total-cheque-"+i).html("$"+m.format(0,3,"."))}}function calculateAmountChecks2(){var a=0,b=0,c=calculatedChecksData.clone();for(k=0;k<c.length;k++)a+=c[k][2][1];for(b=Math.ceil(a/totalChecksGenerate),amountCheck=[],i=0;i<totalChecksGenerate;i++)for(auxAmountCheck=0,k=0;k<c.length;k++)if(console.log(c[k][2][1]),c[k][2][1]>0){var d=c[k][2][1]+auxAmountCheck;if(!(d<=b)){var e=b-auxAmountCheck;amountCheck.push([i,c[k][2][0],e,c[k][2][2]]),c[k][2][1]-=e,c[k][2][2]=0;break}auxAmountCheck+=c[k][2][1],amountCheck.push([i,c[k][2][0],c[k][2][1],c[k][2][2]]),c[k][2][1]=0,c[k][2][2]=0}for(i=0;i<totalChecksGenerate;i++){var f=$("#fecha-cheque-"+i).val(),g=0;for(k=0;k<amountCheck.length;k++)if(amountCheck[k][0]==i){var h=calculateProjectedInterest(f,amountCheck[k][1],amountCheck[k][2]);g+=amountCheck[k][2]+h-amountCheck[k][3]}var j=g%10;j>0&&(j>=5?g+=10-j:g-=j),$("#total-cheque-"+i).html("$"+g.format(0,3,"."))}}function getBackSimulator(){$("#page-2").addClass("hide"),$("#page-1").removeClass("hide")}Number.prototype.format=function(a,b,c,d){var e="\\d(?=(\\d{"+(b||3)+"})+"+(a>0?"\\D":"$")+")",f=this.toFixed(Math.max(0,~~a));return(d?f.replace(".",d):f).replace(new RegExp(e,"g"),"$&"+(c||","))},Array.prototype.clone=function(){for(var a=this.slice(0),b=0;b<this.length;b++)this[b].clone&&(a[b]=this[b].clone());return a};var cont=[],numID=0,data={},amount=0,grossAmount=0,interestAmount=0,studentsData=[],projectedChecks=[],checksData=[],calculatedChecks=[],calculatedChecksData=[],totalChecksGenerate=0;$(function(){loadData();var a=new Date,b=a.getDate(),c=a.getMonth()+1,d=a.getFullYear();b<10&&(b="0"+b),c<10&&(c="0"+c);var a=d+"-"+c+"-"+b;$("#fecha").datepicker({format:"yyyy-mm-dd",language:"es",autoclose:!0,startDate:"-1d"}),$("#fecha").val(a),$("#tag-student").keypress(function(a){13==a.which&&addStudent()}),$("#discount").keypress(function(a){13==a.which&&addDiscount()})});
